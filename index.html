<!DOCTYPE html>
<html>
  <head>
    <title>Sock Chats</title>
    <style>
        body { height: calc(100vh); margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: grid; grid-template-columns: 20% 80%; overflow-wrap: anywhere; }
        img { position: fixed; top: 0; right: 0; width: 50px; margin: 0.55% 0.55% 0% 0%; }

        #login { position: fixed; z-index: 1; height: calc(100vh); width: calc(100vw); background-color: rgba(0, 0, 0, 0.5); }
        #loginform { display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto; height: fit-content; width: fit-content; border-radius: 50px; border: 1px solid black; padding: 2% 5% 4% 5%; font-size: 20px; background-color: #d9edc7; }
        .logintitle { font-size: 30px; margin-bottom: 10%; }
        .grid { width: 100%; display: grid; grid-template-columns: 50% 50%; grid-template-areas: "displayname inputfield" ". submitbutton"; }
        .displayname { grid-area: displayname; text-align: center; }
        .inputfield { grid-area: inputfield; font-size: 20px; padding: 0% 2%; }
        .enterbutton { grid-area: submitbutton; font-size: 20px; }
        .logininfo { margin-bottom: 0; }

        .infocontainer { width: 100%; position: sticky; top: 0; text-align: center; background-color: rgb(172, 228, 172); }
        .info { height: calc(100vh); position: sticky; top: 0; overflow: auto; font-size: 20px; }
        #num_users { font-size: 25px; text-decoration: underline; position: sticky; top: 0; background-color: rgba(245, 245, 245, 0.85); }
        .flexcontainer { height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        #users { list-style-type: none; margin: 0; padding: 0; }
        #users > li:hover { cursor: pointer; background-color: rgb(129, 221, 129) !important; }
        #typingstatus { position: sticky; bottom: 0; background-color: rgba(245, 245, 245, 0.85); }

        .main { display: flex; flex-direction: column; justify-content: space-between; border-left: 1px solid black; }
        #messages { width: 100%; list-style-type: none; margin: 0; padding: 0; font-size: 20px; }
        #messages > li { padding: 0.5rem 1rem; }
        #messages > li:hover { background-color: rgb(245, 245, 245); }
        #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; display: flex; flex-wrap: wrap; position: sticky; bottom: 0; }
        #input { border: none; flex-grow: 1; border-radius: 10px; margin: 0.25rem; padding: 0% 1%; font-size: 35px; }
        #input:focus { outline: none; }
        #form > button { flex-grow: 1; background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 10px; outline: none; color: #fff; }
    </style>
  </head>

  <body>
    <div id="login">
      <form id="loginform" action="">
        <div class="logintitle">ðŸ’» Socket Chat</div>
        <div class="grid">
          <div class="displayname">Display Name:</div>
          <input id="logininput" class="inputfield" autocomplete="off" />
          <button id="enter" class="enterbutton">Enter</button>
        </div>
        <ul class="logininfo">
          <li>Has to be original âœ¨</li>
          <li>Must be 10 characters or less.</li>
          <li>Cannot be <i>nothing</i> or just whitespace.</li>
        </ul>
      </form>
    </div>

    <div class="infocontainer">
      <div class="info">
        <div id="num_users"></div>
        <div class="flexcontainer">
          <ul id="users"></ul>
          <div id="typingstatus"></div>
        </div>
      </div>
    </div>

    <div class="main">
      <ul id="messages">
        <a href="https://github.com/trumanjchan/Socketchat" target="_blank"><img src="/images/github.webp" alt="Github" /></a>
      </ul>
      <form id="form" action="">
        <input id="input" autocomplete="off" />
        <button>Send</button>
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var nickname;
        var loginform = document.getElementById('loginform');
        var logininput = document.getElementById('logininput');

        var num_users = document.getElementById('num_users');
        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var typingstatus = document.getElementById('typingstatus');
        var privatemessaging = false;
        console.log('privatemessaging: ' + privatemessaging);
        var theirname;
        console.log('theirname: ' + theirname);

        loginform.addEventListener('submit', function(e) {
            e.preventDefault();
            if (logininput.value && logininput.value.length < 11 && logininput.value.trim().length != 0) {
                nickname = logininput.value;
                socket.emit('storeClientInfo', { username: nickname });

                socket.on('new-nickname', function() {
                    document.getElementById('login').style.display = 'none';
                    input.focus();
                });
            }
        });
        form.addEventListener('input', function() {
            if (input.value.length > 0) {
                socket.emit('user-typing');
            }
            else if (input.value.length == 0) {
                socket.emit('user-stopped-typing');
            }
        });
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value && !privatemessaging) {
                socket.emit('chat-message', input.value);
                input.value = '';
                socket.emit('user-stopped-typing');
            }
            else if (input.value && privatemessaging) {
                console.log('theirname after submit: ' + theirname);
                console.log('privatemessaging after submit: ' + privatemessaging);
                var pm = input.value;
                socket.emit('private-message', { theirname, pm });
                var item = document.createElement('li');
                item.textContent = "- whispered '" + input.value + "'";
                item.style.fontStyle = 'italic';
                messages.appendChild(item);
                window.scrollTo(0, document.body.scrollHeight);
                input.value = '';
                input.focus();
                socket.emit('user-stopped-typing');
            }
        });
        document.getElementById('users').addEventListener('click', function(e) {
            if (theirname == undefined && !privatemessaging) {
                input.focus();
                theirname = e.target.innerText;
                privatemessaging = true;
                e.target.style.backgroundColor = 'rgb(129, 221, 129)';
                console.log('theirname after click: ' + theirname);
                console.log('privatemessaging after click: ' + privatemessaging);
                var item = document.createElement('li');
                item.textContent = 'You are now whispering to ' + theirname + '.';
                item.style.fontWeight = 'bold';
                messages.appendChild(item);
                window.scrollTo(0, document.body.scrollHeight);
            }
            else if (e.target.innerText == theirname) {
                input.focus();
                theirname = undefined;
                privatemessaging = false;
                e.target.style.backgroundColor = 'transparent';
                console.log('now talking to everyone again');
                var item = document.createElement('li');
                item.textContent = 'You are now speaking to everyone.';
                item.style.fontWeight = 'bold';
                messages.appendChild(item);
                window.scrollTo(0, document.body.scrollHeight);
            }
        });

        socket.on('connect', function(data) {
            logininput.focus();
        });
        socket.on('announce-user', function(user) {
            var item = document.createElement('li');
            item.textContent = 'Welcome, ' + user + '!';
            item.style.color = 'green';
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
        socket.on('user-typing', function(status) {
            typingstatus.innerText = status;
        });
        socket.on('chat-message', function(msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
        socket.on('user-left', function(user) {
            var item = document.createElement('li');
            item.textContent = user + ' has left.';
            item.style.color = 'red';
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
            socket.emit('user-stopped-typing');

            if (user == theirname) {
                theirname = undefined;
                privatemessaging = false;
                console.log('now talking to everyone again');
                var item = document.createElement('li');
                item.textContent = 'Recipient has left. You are now speaking to everyone.';
                item.style.fontWeight = 'bold';
                messages.appendChild(item);
                window.scrollTo(0, document.body.scrollHeight);
            }
        });
        socket.on('update-num-users', function(count) {
            num_users.innerText = 'Online Users: ' + count;
        });
        socket.on('update-user-list', function(clients) {
            var myNode = document.getElementById('users');
            myNode.innerHTML = '';
            for (i = 0; i < clients.length; i++) {
                var item = document.createElement('li');
                item.textContent = clients[i].username;
              
                if (nickname == clients[i].username) {
                  item.style.color = 'white';
                  item.style.letterSpacing = '1.2px';
                }
                if (clients[i].username == theirname && privatemessaging) {
                    item.style.backgroundColor = 'rgb(129, 221, 129)';
                }
                users.appendChild(item);
            }
        });

        socket.on('connect_error', err => {
            var item = document.createElement('li');
            item.textContent = '* The server is offline *';
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
    </script>
  </body>
</html>